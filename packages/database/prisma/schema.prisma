datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider   = "prisma-client"
  output     = "./generated"
  engineType = "client"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./zod"
  config   = "./zod-generator.config.json"
}

model User {
  id                 String       @id @default(cuid())
  name               String
  email              String
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime
  username           String?
  role               String?
  banned             Boolean?
  banReason          String?
  banExpires         DateTime?
  onboardingComplete Boolean      @default(false)
  locale             String?
  displayUsername    String?
  twoFactorEnabled   Boolean?
  sessions           Session[]
  accounts           Account[]
  passkeys           Passkey[]
  invitations        Invitation[]
  purchases          Purchase[]
  members            Member[]
  twofactors         TwoFactor[]
  expenses           Expense[]
  loanPayments       LoanPayment[]

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  token     String
  createdAt DateTime
  updatedAt DateTime

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime
  updatedAt             DateTime

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String   @db.Text
  expiresAt  DateTime

  createdAt DateTime?
  updatedAt DateTime?

  @@index([identifier])
  @@map("verification")
}

model Passkey {
  id           String    @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  aaguid       String?
  createdAt    DateTime?

  @@index([userId])
  @@index([credentialID])
  @@map("passkey")
}

model TwoFactor {
  id          String @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([secret])
  @@index([userId])
  @@map("twoFactor")
}

model Organization {
  id                 String       @id @default(cuid())
  name               String
  slug               String?
  logo               String?
  createdAt          DateTime
  metadata           String?
  paymentsCustomerId String?
  // Custom domain configuration
  customDomain       String?
  customDomainEnabled Boolean     @default(false)
  domainConfiguredAt DateTime?
  domainVerifiedAt   DateTime?
  members            Member[]
  invitations        Invitation[]
  purchases          Purchase[]
  usageMetrics       UsageMetric[]
  expenseAccounts    ExpenseAccount[]
  expenseCategories  ExpenseCategory[]
  paymentMethods     PaymentMethod[]
  expenseReports     ExpenseReport[]
  currencyRates      CurrencyRate[]

  @@unique([slug])
  @@index([customDomain])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

enum PurchaseType {
  SUBSCRIPTION
  ONE_TIME
}

model Purchase {
  id             String        @id @default(cuid())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  type           PurchaseType
  customerId     String
  subscriptionId String?       @unique
  productId      String
  status         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([subscriptionId])
  @@map("purchase")
}

model UsageMetric {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Metric type: "shares", "projects", "ai_analyses", etc.
  metricType     String
  
  // Current usage count
  currentUsage   Int          @default(0)
  
  // Soft limit (triggers warning at this threshold)
  softLimit      Int?
  
  // Hard limit (blocks creation)
  hardLimit      Int?
  
  // Metadata for additional context (JSON)
  metadata       Json?
  
  // Period tracking (for monthly limits, if needed later)
  periodStart    DateTime?
  periodEnd      DateTime?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@unique([organizationId, metricType])
  @@index([organizationId])
  @@index([metricType])
  @@map("usageMetric")
}

model ExpenseAccount {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  currency       String       @default("USD")
  type           String       @default("business")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  teamMembers    TeamMember[]
  teamMemberAccounts TeamMemberAccount[]
  expenses       Expense[]
  expenseReports ExpenseReport[]

  @@index([organizationId])
  @@map("expenseAccount")
}

model ExpenseCategory {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  type           String       @default("custom")
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  expenses       Expense[]

  @@index([organizationId])
  @@map("expenseCategory")
}

model TeamMember {
  id          String          @id @default(cuid())
  businessId String?
  expenseAccount   ExpenseAccount?        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name        String
  email       String?
  position    String?
  joinedDate  DateTime?
  salary      Decimal?
  status      String          @default("active")
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  expenses    Expense[]
  loans       TeamMemberLoan[]
  accounts    TeamMemberAccount[]

  @@index([businessId])
  @@map("teamMember")
}

model TeamMemberAccount {
  id          String          @id @default(cuid())
  teamMemberId String
  teamMember  TeamMember      @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  accountId   String
  account     ExpenseAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  joinedDate  DateTime?
  salary      Decimal?
  position    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([teamMemberId, accountId])
  @@index([teamMemberId])
  @@index([accountId])
  @@map("teamMemberAccount")
}

model PaymentMethod {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  type           String
  lastFourDigits String?
  isDefault      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  expenses       Expense[]

  @@index([organizationId])
  @@map("paymentMethod")
}

model Expense {
  id             String        @id @default(cuid())
  businessId     String
  expenseAccount       ExpenseAccount      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  categoryId    String
  category       ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  teamMemberId   String?
  teamMember     TeamMember?  @relation(fields: [teamMemberId], references: [id], onDelete: SetNull)
  paymentMethodId String?
  paymentMethod  PaymentMethod? @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  title          String
  description    String?
  amount         Decimal
  currency       String        @default("USD")
  // Currency conversion tracking
  conversionRate Decimal?      // Rate used at creation time (1 USD = rate * currency)
  rateType       String?       // "default" or "custom"
  baseCurrencyAmount Decimal?  // Amount in base currency (USD) at creation time
  date           DateTime
  receiptUrl     String?
  status         String        @default("active")
  metadata       Json?
  createdBy      String
  creator        User          @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  subscription   Subscription?
  loan           TeamMemberLoan?

  @@index([businessId])
  @@index([categoryId])
  @@index([teamMemberId])
  @@index([date])
  @@index([createdBy])
  @@map("expense")
}

model Subscription {
  id                String    @id @default(cuid())
  expenseId         String    @unique
  expense           Expense   @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  renewalDate       DateTime
  renewalFrequency  String    @default("monthly")
  autoRenew         Boolean   @default(true)
  reminderDays     Int       @default(7)
  nextReminderDate  DateTime?
  cancelationDate   DateTime?
  provider          String?
  status            String    @default("active")
  reminders         ExpenseReminder[]

  @@index([expenseId])
  @@index([renewalDate])
  @@index([nextReminderDate])
  @@index([status])
  @@map("subscription")
}

model TeamMemberLoan {
  id              String        @id @default(cuid())
  expenseId       String        @unique
  expense         Expense       @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  teamMemberId    String
  teamMember      TeamMember    @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  principalAmount Decimal
  remainingAmount Decimal
  loanDate        DateTime
  notes           String?
  status          String        @default("active")
  payments        LoanPayment[]

  @@index([expenseId])
  @@index([teamMemberId])
  @@index([status])
  @@map("teamMemberLoan")
}

model LoanPayment {
  id           String        @id @default(cuid())
  loanId       String
  loan         TeamMemberLoan @relation(fields: [loanId], references: [id], onDelete: Cascade)
  amount       Decimal
  paymentDate  DateTime
  paymentMethod String?
  notes        String?
  recordedBy   String
  recorder     User          @relation(fields: [recordedBy], references: [id], onDelete: Restrict)
  createdAt    DateTime      @default(now())

  @@index([loanId])
  @@map("loanPayment")
}

model ExpenseReport {
  id                String       @id @default(cuid())
  organizationId   String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessId        String?
  expenseAccount          ExpenseAccount?    @relation(fields: [businessId], references: [id], onDelete: SetNull)
  reportName        String?
  reportType        String       @default("all_categories")
  reportPeriodStart DateTime
  reportPeriodEnd   DateTime
  selectedAccountIds Json?
  totalExpenses     Decimal      @default(0)
  reportCurrency    String       @default("USD")
  categoryBreakdown Json?
  reportData        Json
  isScheduled       Boolean      @default(false)
  generatedAt       DateTime     @default(now())
  emailSentAt       DateTime?

  @@index([organizationId])
  @@index([businessId])
  @@index([reportType])
  @@map("expenseReport")
}

model CurrencyRate {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fromCurrency   String       // Base currency (always USD)
  toCurrency     String       // Target currency
  rate           Decimal      // Conversion rate: 1 USD = rate * toCurrency
  symbol         String?      // Currency symbol (e.g., $, €, £)
  symbolPosition String       @default("left") // "left" or "right"
  separator       String       @default(",") // Thousands separator (e.g., ",", ".", " ")
  decimalSeparator String     @default(".") // Decimal separator (e.g., ".", ",")
  updatedAt      DateTime     @default(now())
  updatedBy      String?

  @@unique([organizationId, toCurrency])
  @@index([organizationId])
  @@map("currencyRate")
}

model ExpenseReminder {
  id            String       @id @default(cuid())
  subscriptionId String
  subscription  Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  reminderType  String
  scheduledDate DateTime
  sentDate      DateTime?
  status        String       @default("pending")
  emailContent  String?

  @@index([subscriptionId])
  @@index([scheduledDate])
  @@index([status])
  @@map("expenseReminder")
}
